#!/usr/bin/env bash

echo "I am provisioning..."
sudo sh -c 'date > /etc/vagrant_provisioned_at'

echo "Installing dependencies"
sudo add-apt-repository -y ppa:presslabs/gitfs
sudo apt-get update
sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -q python3-dev python3-venv libffi-dev build-essential git-core libgit2-dev libfuse-dev libfuse2

echo "Configuring fuse"
sudo groupadd fuse
sudo adduser vagrant fuse
sudo sh -c "echo 'user_allow_other' >> /etc/fuse.conf"

echo "Configure virtualenv"
python3 -m venv /home/vagrant/gitfs
echo "source /home/vagrant/gitfs/bin/activate" >> "$HOME/.bashrc"

echo Installing whell
/home/vagrant/gitfs/bin/pip install -q 'wheel'

echo Installing cffi
/home/vagrant/gitfs/bin/pip install -q 'cffi'

echo Installing requirements
/home/vagrant/gitfs/bin/pip install -q -r /vagrant/test_requirements.txt

echo Configuring git
git config --global user.email "vagrant@localhost"
git config --global user.name "Vagrant"

echo Installing gitfs
/home/vagrant/gitfs/bin/pip install -q -e /vagrant
